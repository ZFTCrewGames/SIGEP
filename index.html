<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGEP - Gestión de Planillas</title>
    
    <!-- FAVICON (Escudo/Archivo) -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjOGI5MmY3IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgY2xhc3M9ImZlYXRoZXIgZmVhdGhlci1zaGllbGQiPjxwYXRoIGQ9Ik0xMiAyMmM1LjUyMyAwIDEwLTQuNDc3IDEwLTEwUzE3LjUyMyAyIDEyIDIgMiA2LjQ3NyAyIDEyczQuNDc3IDEwIDEwIDEwek0xMiA2djYiLz48cGF0aCBkPSJNMTIgMThsLTMtMy4wMCIvPjxwYXRoIGQ9Ik0xMiAxOGwzLTMuMDAiLz48cGF0aCBkPSJNMTIgNnY2IiAvPz48cGF0aCBkPSJNMTIgMTJsNyA3IiAvPz48cGF0aCBkPSJNMTIgMTJsNyA3IiAvPz48L3N2ZyA+">

    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Iconos (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        /* Estilos para que los selects se vean consistentes en modo oscuro */
        select, input[type="date"], input[type="text"], input[type="number"], input[type="month"] {
            border-color: #374151; /* slate-600 */
            background-color: #374151; /* slate-700 */
            color: #f3f4f6; /* neutral-200 */
        }
        select {
            appearance: none;
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 20 20"><path stroke="%239CA3AF" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m6 8 4 4 4-4"/></svg>');
        }
        input[type="date"], input[type="month"] {
            color-scheme: dark;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Scrollbar oscuro */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .view-section { display: none; }
        .view-section.active { display: block; }
        
        .loader {
            border-top-color: #4f46e5; /* indigo-600 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Estilo para tachar un elemento pagado */
        .paid-indicator:before {
            content: " ";
            display: block;
            width: 100%;
            height: 2px;
            background-color: #10B981; /* emerald-500 */
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            opacity: 0.7;
            z-index: 10;
            pointer-events: none;
        }
        
        /* Estilo para campos monetarios de detalle */
        .detalle-monto-input {
             font-size: 0.875rem; /* text-sm */
             padding: 0.5rem 0.75rem; 
             height: auto;
             line-height: normal;
        }
        /* Estilos para radio buttons */
        input[type="radio"].text-green-500:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e");
            background-color: #22c55e; /* green-500 */
            border-color: #22c55e;
        }
         input[type="radio"].text-red-500:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e");
            background-color: #ef4444; /* red-500 */
            border-color: #ef4444;
        }
    </style>
</head>
<body class="text-neutral-200">

    <!-- PANTALLA DE LOGIN (Visible por defecto) -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-900">
        <div class="bg-slate-800 p-8 rounded-lg shadow-xl text-center w-full max-w-sm">
            <i data-feather="file-text" class="w-12 h-12 text-indigo-400 mx-auto mb-4"></i>
            <h1 class="text-2xl font-bold text-white mb-2">SIGEP</h1>
            <p class="text-neutral-400 mb-6">Sistema de Gestión de Planillas</p>
            <button id="login-button" class="w-full inline-flex justify-center items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-800">
                <!-- Icono de Google SVG -->
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 20a10 10 0 1 1 0-20 10 10 0 0 1 0 20zM7.188 5.031C6.918 6.007 6.66 7.438 6.66 8.5c0 .01 0 .02-.002.03a11.12 11.12 0 0 0 .666 3.61c.002.007.003.014.005.021a6.979 6.979 0 0 0 1.22 1.939c.13.14.264.275.4.406a4.414 4.414 0 0 0 1.09 1.51 4.5 4.5 0 0 0 5.432-1.513c.132-.136.265-.274.396-.412a6.977 6.977 0 0 0 1.22-1.938c.002-.007.003-.014.005-.021a11.12 11.12 0 0 0 .666-3.61c0-.01 0-.02-.002-.03c0-1.062-.258-2.493-.528-3.469a.5.5 0 0 0-.943.264c.248.892.49 2.21.49 3.205c0 .007 0 .013-.002.02a9.125 9.125 0 0 1-.55 2.97c-.003.013-.006.026-.01.039a4.982 4.982 0 0 1-.87 1.38c-.125.132-.255.26-.388.384a2.498 2.498 0 0 1-3.03 0c-.133-.124-.263-.252-.388-.384a4.982 4.982 0 0 1-.87-1.38c-.003-.013-.006.026-.01-.039a9.125 9.125 0 0 1-.55-2.97c0-.007 0 .013-.002-.02c0-.995.242-2.313.49-3.205a.5.5 0 0 0-.943-.264z"></path></svg>
                Iniciar Sesión con Google
            </button>
            <p id="login-error" class="text-red-400 text-sm mt-4"></p>
        </div>
    </div>

    <!-- INTERFAZ PRINCIPAL (Oculta por defecto) -->
    <div id="main-app" class="hidden">
        <div class="flex h-screen bg-gray-900">
            <!-- Sidebar -->
            <aside class="w-64 flex-shrink-0 bg-slate-800 flex flex-col">
                <div class="h-16 flex items-center justify-center px-4 shadow-md shadow-slate-900/20">
                    <i data-feather="shield" class="w-6 h-6 text-indigo-400 mr-3"></i>
                    <h1 class="text-xl font-semibold text-white">SIGEP</h1>
                </div>
                <nav class="flex-1 overflow-y-auto mt-4 space-y-2 px-3">
                    <a href="#" data-view="view-dashboard" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md text-white bg-indigo-600">
                        <i data-feather="grid" class="w-5 h-5 mr-3"></i>
                        Dashboard
                    </a>
                    <a href="#" data-view="view-archive" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md text-neutral-300 hover:bg-slate-700 hover:text-white">
                        <i data-feather="archive" class="w-5 h-5 mr-3"></i>
                        Archivo por Fecha
                    </a>
                    <a href="#" data-view="view-agregar" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md text-neutral-300 hover:bg-slate-700 hover:text-white">
                        <i data-feather="plus-circle" class="w-5 h-5 mr-3"></i>
                        Agregar Registro
                    </a>
                </nav>
                <div class="p-4 border-t border-slate-700">
                    <!-- Info de Usuario -->
                    <div class="flex items-center">
                        <img id="user-photo" class="h-10 w-10 rounded-full" src="https://placehold.co/40x40/606060/FFFFFF?text=?" alt="User photo">
                        <div class="ml-3">
                            <p id="user-name" class="text-sm font-medium text-white">Cargando...</p>
                            <p id="user-email" class="text-xs text-neutral-400">...</p>
                        </div>
                    </div>
                    <button id="logout-button" class="w-full text-left mt-4 flex items-center px-3 py-2 text-sm font-medium rounded-md text-neutral-300 hover:bg-slate-700 hover:text-white">
                        <i data-feather="log-out" class="w-5 h-5 mr-3"></i>
                        Cerrar Sesión
                    </button>
                </div>
            </aside>

            <!-- Contenido Principal -->
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
                
                <!-- VISTA: DASHBOARD (Ver Registros) -->
                <section id="view-dashboard" class="view-section active">
                    <h2 class="text-2xl font-semibold text-white mb-6">Dashboard de Registros</h2>
                    
                    <!-- Sección de Filtros -->
                    <form id="filterForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-slate-800 rounded-lg shadow-lg">
                        <div>
                            <label for="searchExpediente" class="block text-sm font-medium text-neutral-300">Buscar por Expediente</label>
                            <input type="text" id="searchExpediente" name="searchExpediente" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white" placeholder="Buscar...">
                        </div>
                        <div>
                            <label for="filterEstado" class="block text-sm font-medium text-neutral-300">Filtrar por Estado Remisión</label>
                            <select id="filterEstado" name="filterEstado" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                <option value="">Todos</option>
                                <option value="oficina">En Oficina</option>
                                <option value="presupuesto">En Presupuesto</option>
                                <option value="secretaria">En Secretaría</option>
                                <option value="pagado">Pagado</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterFechaInicio" class="block text-sm font-medium text-neutral-300">Fecha Envío Desde</label>
                            <input type="date" id="filterFechaInicio" name="filterFechaInicio" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                        </div>
                        <div>
                            <label for="filterFechaFin" class="block text-sm font-medium text-neutral-300">Fecha Envío Hasta</label>
                            <input type="date" id="filterFechaFin" name="filterFechaFin" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:focus:border-indigo-500 sm:text-sm text-white">
                        </div>
                        <div class="sm:col-span-2 lg:col-span-4 flex items-center space-x-2">
                            <button type="button" id="filterButton" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-800">
                                Filtrar
                            </button>
                            <button type="button" id="clearFilterButton" class="w-full inline-flex justify-center py-2 px-4 border border-slate-600 shadow-sm text-sm font-medium rounded-md text-neutral-200 bg-slate-700 hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-800">
                                Limpiar Filtros
                            </button>
                        </div>
                    </form>

                    <!-- Contenedor de Tarjetas -->
                    <div id="loading" class="flex justify-center items-center py-10">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-600 h-12 w-12"></div>
                        <p class="ml-4 text-neutral-400">Cargando datos...</p>
                    </div>

                    <div id="planillasContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Las tarjetas se insertarán aquí dinámicamente -->
                    </div>
                    <p id="noResults" class="text-center text-neutral-500 py-10 hidden">No se encontraron registros que coincidan con los filtros.</p>
                </section>

                <!-- VISTA: ARCHIVO POR FECHA -->
                <section id="view-archive" class="view-section">
                    <h2 class="text-2xl font-semibold text-white mb-6">Archivo por Fecha</h2>
                    <div id="archiveContainer" class="space-y-12">
                        <!-- El contenido se genera dinámicamente -->
                    </div>
                </section>


                <!-- VISTA: AGREGAR/EDITAR REGISTRO -->
                <section id="view-agregar" class="view-section">
                    <h2 class="text-2xl font-semibold text-white mb-6" id="form-title">Agregar Nuevo Registro</h2>
                    <div class="bg-slate-800 p-6 rounded-lg shadow-lg max-w-4xl mx-auto">
                        <form id="addForm" class="space-y-6">
                            <input type="hidden" id="registroId" name="registroId">

                            <!-- Sección Fechas -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="fechaPlanilla" class="block text-sm font-medium text-neutral-300">Fecha Ref. Planilla (Ej: 2025-08)</label>
                                    <!-- Input para Mes y Año (YYYY-MM) -->
                                    <input type="month" id="fechaPlanilla" name="fechaPlanilla" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                </div>
                                <div>
                                    <label for="fechaEnvio" class="block text-sm font-medium text-neutral-300">Fecha de Elaboración (Trabajo)</label>
                                    <input type="date" id="fechaEnvio" name="fechaEnvio" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                </div>
                            </div>

                            <!-- Sección Datos Principales -->
                            <div>
                                <h3 class="text-lg font-medium text-indigo-300 border-b border-slate-700 pb-2 mb-4">Datos del Documento</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label for="tipoDocumento" class="block text-sm font-medium text-neutral-300">Tipo de Documento</label>
                                        <select id="tipoDocumento" name="tipoDocumento" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                            <option value="Planilla">Planilla</option>
                                            <option value="Informe">Informe</option>
                                            <option value="Remisión">Remisión</option>
                                            <option value="Solicitud">Solicitud</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="expediente" class="block text-sm font-medium text-neutral-300">N° de Expediente (Principal)</label>
                                        <input type="text" id="expediente" name="expediente" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white" placeholder="Ej: 2025-001-A">
                                    </div>
                                    <div>
                                        <label for="unidadEjecutora" class="block text-sm font-medium text-neutral-300">Unidad Ejecutora Principal</label>
                                        <select id="unidadEjecutora" name="unidadEjecutora" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                            <option value="11">11 - Fuerza del Ejército</option>
                                            <option value="12">12 - Fuerza Aérea</option>
                                            <option value="13">13 - Fuerza Naval</option>
                                            <option value="14">14 - Estado Mayor Conjunto</option>
                                            <option value="15">15 - Hospital Militar</option>
                                            <option value="32">32 - PMOP</option>
                                            <option value="FA">Fuerzas Armadas (FA)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                    <div class="md:col-span-2">
                                        <label for="objetoGasto" class="block text-sm font-medium text-neutral-300">Objeto de Gasto</label>
                                        <select id="objetoGasto" name="objetoGasto" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                            <option value="Haberes">Haberes</option>
                                            <option value="Vacaciones">Vacaciones</option>
                                            <option value="Bonificación">Bonificación</option>
                                            <option value="Décimo Tercero">Décimo Tercero</option>
                                            <option value="Décimo Cuarto">Décimo Cuarto</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="tipoPlanilla" class="block text-sm font-medium text-neutral-300">Tipo de Planilla</label>
                                        <select id="tipoPlanilla" name="tipoPlanilla" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                            <option value="Ordinaria">Ordinaria</nd>
                                            <option value="Complementaria">Complementaria</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sección Unidades Ejecutoras Adicionales (Condicional FA) -->
                            <div id="faCategoriesSection" class="hidden">
                                <h3 class="text-lg font-medium text-indigo-300 border-b border-slate-700 pb-2 mb-4">UEs Incluidas en Documento (FA)</h3>
                                <p class="text-sm text-neutral-400 mb-3">Selecciona las Unidades Ejecutoras específicas que abarca este documento (Opcional):</p>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 p-4 bg-slate-700 rounded-md">
                                    <label class="flex items-center space-x-2 text-sm text-white">
                                        <input type="checkbox" name="faUeIncludes" value="11" class="h-4 w-4 text-indigo-600 rounded border-slate-500 focus:ring-indigo-500">
                                        <span>11 - Ejército</span>
                                    </label>
                                    <label class="flex items-center space-x-2 text-sm text-white">
                                        <input type="checkbox" name="faUeIncludes" value="12" class="h-4 w-4 text-indigo-600 rounded border-slate-500 focus:ring-indigo-500">
                                        <span>12 - Aérea</span>
                                    </label>
                                    <label class="flex items-center space-x-2 text-sm text-white">
                                        <input type="checkbox" name="faUeIncludes" value="13" class="h-4 w-4 text-indigo-600 rounded border-slate-500 focus:ring-indigo-500">
                                        <span>13 - Naval</span>
                                    </label>
                                    <label class="flex items-center space-x-2 text-sm text-white">
                                        <input type="checkbox" name="faUeIncludes" value="14" class="h-4 w-4 text-indigo-600 rounded border-slate-500 focus:ring-indigo-500">
                                        <span>14 - E.M.C.</span>
                                    </label>
                                    <label class="flex items-center space-x-2 text-sm text-white">
                                        <input type="checkbox" name="faUeIncludes" value="15" class="h-4 w-4 text-indigo-600 rounded border-slate-500 focus:ring-indigo-500">
                                        <span>15 - H. Militar</span>
                                    </label>
                                    <label class="flex items-center space-x-2 text-sm text-white">
                                        <input type="checkbox" name="faUeIncludes" value="32" class="h-4 w-4 text-indigo-600 rounded border-slate-500 focus:ring-indigo-500">
                                        <span>32 - PMOP</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Sección Estado del Personal (Múltiple) -->
                            <div>
                                <h3 class="text-lg font-medium text-indigo-300 border-b border-slate-700 pb-2 mb-4">Estado del Personal</h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 p-4 bg-slate-700 rounded-md">
                                    <label class="flex items-center space-x-2 text-sm text-white">
                                        <input type="checkbox" name="personalState" value="Activa" class="h-4 w-4 text-indigo-600 rounded border-slate-500 focus:ring-indigo-500">
                                        <span>Activa</span>
                                    </label>
                                    <label class="flex items-center space-x-2 text-sm text-white">
                                        <input type="checkbox" name="personalState" value="Baja" class="h-4 w-4 text-indigo-600 rounded border-slate-500 focus:ring-indigo-500">
                                        <span>Baja</span>
                                    </label>
                                    <label class="flex items-center space-x-2 text-sm text-white">
                                        <input type="checkbox" name="personalState" value="Cambio de Categoría" class="h-4 w-4 text-indigo-600 rounded border-slate-500 focus:ring-indigo-500">
                                        <span>Cambio de Categoría</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Sección Observaciones -->
                            <div>
                                <label for="observacionesPersonal" class="block text-sm font-medium text-neutral-300">Observaciones</label>
                                <textarea id="observacionesPersonal" name="observacionesPersonal" rows="3" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white" placeholder="Notas sobre el documento."></textarea>
                            </div>

                            <!-- Sección Seguimiento de Remisiones -->
                            <div>
                                <h3 class="text-lg font-medium text-indigo-300 border-b border-slate-700 pb-2 mb-4">Seguimiento (Presupuesto / Secretaría)</h3>
                                <div class="space-y-4">
                                    <!-- Presupuesto -->
                                    <div class="bg-slate-700/50 p-4 rounded-lg">
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="checkPresupuesto" class="h-4 w-4 text-indigo-600 rounded border-slate-500 focus:ring-indigo-500">
                                            <span class="text-md font-medium text-white">Enviado a Presupuesto</span>
                                        </label>
                                        <div id="fieldsPresupuesto" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3 hidden">
                                            <div>
                                                <label for="fechaEnvioPresupuesto" class="block text-sm font-medium text-neutral-300">Fecha de Envío a Presupuesto</label>
                                                <input type="date" id="fechaEnvioPresupuesto" name="fechaEnvioPresupuesto" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                            </div>
                                            <div>
                                                <label for="expedientePresupuesto" class="block text-sm font-medium text-neutral-300">N° Expediente de Presupuesto</label>
                                                <input type="text" id="expedientePresupuesto" name="expedientePresupuesto" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white" placeholder="Ej: P-2025-150">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Secretaría -->
                                    <div class="bg-slate-700/50 p-4 rounded-lg">
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="checkSecretaria" class="h-4 w-4 text-indigo-600 rounded border-slate-500 focus:ring-indigo-500">
                                            <span class="text-md font-medium text-white">Enviado a Secretaría</span>
                                        </label>
                                        <div id="fieldsSecretaria" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3 hidden">
                                            <div>
                                                <label for="fechaEnvioSecretaria" class="block text-sm font-medium text-neutral-300">Fecha de Envío a Secretaría</label>
                                                <input type="date" id="fechaEnvioSecretaria" name="fechaEnvioSecretaria" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                            </div>
                                            <div>
                                                <label for="expedienteSecretaria" class="block text-sm font-medium text-neutral-300">N° Expediente de Secretaría</label>
                                                <input type="text" id="expedienteSecretaria" name="expedienteSecretaria" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white" placeholder="Ej: S-2025-300">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sección CONTROL MONETARIO DETALLADO POR UE -->
                            <div class="bg-slate-700 p-6 rounded-lg shadow-inner">
                                <h3 class="text-lg font-medium text-green-400 border-b border-slate-600 pb-2 mb-4">Control Monetario Detallado (Por UE)</h3>
                                
                                <div id="detalleMonetarioContainer" class="space-y-4">
                                    <!-- Las líneas de detalle se insertarán aquí -->
                                </div>
                                
                                <button type="button" id="addDetalleBtn" class="mt-4 w-full inline-flex justify-center py-2 px-4 border border-indigo-600 text-sm font-medium rounded-md text-indigo-300 bg-slate-800 hover:bg-slate-700">
                                    <i data-feather="plus" class="w-5 h-5 mr-2"></i>
                                    Agregar Detalle Monetario
                                </button>
                                
                                <div class="mt-6 pt-4 border-t border-slate-600 flex justify-between items-center">
                                    <span class="text-lg font-bold text-white">TOTAL GENERAL NETO:</span>
                                    <span id="totalNetoDisplay" class="text-2xl font-extrabold text-green-400">L. 0.00</span>
                                </div>
                            </div>

                            <!-- Sección Control de Pago (Global) -->
                            <div class="pt-4 flex flex-col justify-center space-y-2 p-3 bg-slate-700 rounded-md">
                                <h3 class="text-lg font-medium text-indigo-300 border-b border-slate-600 pb-2 mb-2">Control de Pago Global</h3>
                                <!-- CAMBIO: Reemplazado checkbox por dos radios -->
                                <div class="flex items-center space-x-6 py-2">
                                    <label for="radioPagado" class="flex items-center space-x-2 text-sm font-medium text-white">
                                        <input type="radio" id="radioPagado" name="estadoPago" value="pagado" class="h-4 w-4 text-green-500 border-slate-500 focus:ring-green-500">
                                        <span>Pagado</span>
                                    </label>
                                    <label for="radioNoPagado" class="flex items-center space-x-2 text-sm font-medium text-white">
                                        <input type="radio" id="radioNoPagado" name="estadoPago" value="noPagado" class="h-4 w-4 text-red-500 border-slate-500 focus:ring-red-500" checked>
                                        <span>No Pagado</span>
                                    </label>
                                </div>
                            </div>


                            <!-- Botón de Enviar -->
                            <div class="pt-4">
                                <button type="submit" class="w-full inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-800">
                                    <span id="submit-button-text">Guardar Registro</span>
                                </button>
                                <button type="button" id="cancelEditButton" class="w-full mt-2 inline-flex justify-center py-3 px-6 border border-slate-600 shadow-sm text-base font-medium rounded-md text-neutral-200 bg-slate-700 hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-800 hidden">
                                    Cancelar Edición
                                </button>
                            </div>
                        </form>
                    </div>
                </section>
                
                <!-- Modal de Confirmación (Custom) -->
                <div id="customModal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50 hidden">
                    <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm border border-slate-700">
                        <h3 class="text-lg font-medium text-white" id="modal-title"></h3>
                        <p class="mt-2 text-sm text-neutral-400" id="modal-message"></p>
                        <div class="mt-4 flex justify-end space-x-3">
                            <button id="modal-cancel" class="py-2 px-4 border border-slate-600 rounded-md shadow-sm text-sm font-medium text-neutral-200 bg-slate-700 hover:bg-slate-600">Cancelar</button>
                            <button id="modal-confirm" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700">Eliminar</button>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            collection, 
            onSnapshot, 
            query,
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase (proporcionada por el usuario) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA9l_RrRwP8gvmrvhEBpAV0aV4v9sMG-UA",
            authDomain: "sigep-planillas.firebaseapp.com",
            projectId: "sigep-planillas",
            storageBucket: "sigep-planillas.firebasestorage.app",
            messagingSenderId: "707813910405",
            appId: "1:707813910405:web:2d878a07039d0bbaa046ec"
        };
        
        // --- Variables Globales ---
        let app, auth, db, provider, userId, collectionPath;
        let allPlanillas = [];
        let unsubscribe;

        // --- Mapas y Constantes ---
        const ueOptions = {
            "11": "11 - Fuerza del Ejército", "12": "12 - Fuerza Aérea",
            "13": "13 - Fuerza Naval", "14": "14 - Estado Mayor Conjunto",
            "15": "15 - Hospital Militar", "32": "32 - PMOP",
            "FA": "Fuerzas Armadas (FA)"
        };
        const monthNames = [
            "01-Enero", "02-Febrero", "03-Marzo", "04-Abril", "05-Mayo", "06-Junio",
            "07-Julio", "08-Agosto", "09-Septiembre", "10-Octubre", "11-Noviembre", "12-Diciembre"
        ];

        // --- Selectores del DOM ---
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const navLinks = document.querySelectorAll('.nav-link');
        const viewSections = document.querySelectorAll('.view-section');
        const addForm = document.getElementById('addForm');
        const formTitle = document.getElementById('form-title');
        const submitButtonText = document.getElementById('submit-button-text');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const registroIdInput = document.getElementById('registroId');
        
        const planillasContainer = document.getElementById('planillasContainer');
        const archiveContainer = document.getElementById('archiveContainer');
        
        // Formulario "Agregar" campos específicos
        const unidadEjecutoraSelect = document.getElementById('unidadEjecutora');
        const faCategoriesSection = document.getElementById('faCategoriesSection');
        const faUeIncludesInputs = faCategoriesSection.querySelectorAll('input[name="faUeIncludes"]');
        const personalStateInputs = document.querySelectorAll('input[name="personalState"]');
        
        const checkPresupuesto = document.getElementById('checkPresupuesto');
        const fieldsPresupuesto = document.getElementById('fieldsPresupuesto');
        const checkSecretaria = document.getElementById('checkSecretaria');
        const fieldsSecretaria = document.getElementById('fieldsSecretaria');
        
        // Control Monetario Dinámico
        const detalleMonetarioContainer = document.getElementById('detalleMonetarioContainer');
        const addDetalleBtn = document.getElementById('addDetalleBtn');
        const totalNetoDisplay = document.getElementById('totalNetoDisplay');
        
        // --- Funciones de Utilidad ---

        /**
         * Maneja la navegación de la barra lateral.
         */
        function handleNavClick(e) {
            e.preventDefault();
            const targetView = e.currentTarget.dataset.view;
            document.querySelectorAll('.view-section').forEach(section => section.classList.remove('active'));
            document.getElementById(targetView).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-indigo-600', 'text-white');
                link.classList.add('text-neutral-300', 'hover:bg-slate-700', 'hover:text-white');
            });
            e.currentTarget.classList.add('bg-indigo-600', 'text-white');
            e.currentTarget.classList.remove('text-neutral-300', 'hover:bg-slate-700', 'hover:text-white');
            if (targetView === 'view-agregar') resetForm();
            feather.replace();
        }

        /**
         * Muestra/oculta campos de seguimiento.
         */
        function toggleFields(fieldsDiv, isChecked) {
            if (isChecked) fieldsDiv.classList.remove('hidden');
            else fieldsDiv.classList.add('hidden');
        }

        /**
         * Determina el estado de remisión del documento.
         */
        function getEstado(p) {
            if (p.checkPagado) return 'pagado';
            if (p.fechaEnvioSecretaria) return 'secretaria';
            if (p.fechaEnvioPresupuesto) return 'presupuesto';
            return 'oficina';
        }

        /**
         * Formatea un valor numérico a moneda con separador de miles.
         * @param {number|string} value - El número a formatear.
         */
        function formatNumber(value) {
            const num = parseFloat(String(value).replace(/,/g, ''));
            if (isNaN(num)) return '0.00'; // Devolver '0.00' si no es un número
            return num.toLocaleString('en-US', { // Usar 'en-US' para comas como miles y punto decimal
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        /**
         * Quita el formato de un número (comas).
         * @param {string} value - El número formateado.
         */
        function unformatNumber(value) {
            return String(value).replace(/,/g, '');
        }

        /**
         * Formatea a moneda para la visualización en tarjeta.
         */
        function formatMoney(value) {
            return `L. ${formatNumber(value)}`;
        }
        
        // --- Control Monetario Dinámico ---
        
        /**
         * Calcula el total general neto de todos los detalles monetarios.
         */
        function updateTotalNeto() {
            let totalNeto = 0;
            const detailLines = detalleMonetarioContainer.querySelectorAll('.detalle-linea');
            
            detailLines.forEach(line => {
                const netoInput = line.querySelector('.input-neto');
                const netoValue = parseFloat(unformatNumber(netoInput.value)) || 0;
                totalNeto += netoValue;
            });
            
            totalNetoDisplay.textContent = formatMoney(totalNeto);
        }

        /**
         * Calcula el neto de una línea de detalle.
         */
        function calculateDetalleNeto(line) {
            const totalInput = line.querySelector('.input-total');
            const deduccionesInput = line.querySelector('.input-deducciones');
            const netoInput = line.querySelector('.input-neto');
            
            // Reemplazar comas para parsear a número
            const total = parseFloat(unformatNumber(totalInput.value)) || 0;
            const deducciones = parseFloat(unformatNumber(deduccionesInput.value)) || 0;
            const neto = total - deducciones;
            
            // Aplicar formato al Neto y actualizar
            netoInput.value = formatNumber(neto);
            
            updateTotalNeto();
        }

        /**
         * Evento para aplicar formato al perder el foco (blur)
         */
        function handleMoneyInputBlur(e) {
            e.target.value = formatNumber(e.target.value); // Formatear al salir
            
            // Recalcular neto si cambia Total o Deducciones
            const line = e.target.closest('.detalle-linea');
            if (line) calculateDetalleNeto(line);
        }
        
        /**
         * Evento para quitar formato al ganar el foco (focus)
         */
        function handleMoneyInputFocus(e) {
             e.target.value = unformatNumber(e.target.value); // Quitar formato al entrar
        }


        /**
         * Crea una nueva línea de detalle monetario.
         * @param {object} detailData - Datos opcionales para inicializar la línea (en modo edición).
         */
        function createDetalleMonetarioLine(detailData = {}) {
            const lineDiv = document.createElement('div');
            lineDiv.className = 'detalle-linea grid grid-cols-1 md:grid-cols-7 gap-2 p-3 bg-slate-800 rounded-md border border-slate-700 items-end';
            
            // Valores iniciales (sin formato para 'value', formateado para 'display' si es readonly)
            const totalInitial = detailData.total || '';
            const deduccionesInitial = detailData.deducciones || '';
            const netoFormatted = detailData.neto ? formatNumber(detailData.neto) : '0.00';

            lineDiv.innerHTML = `
                <!-- UE -->
                <div class="col-span-2">
                    <label class="block text-xs font-medium text-neutral-400 mb-1">UE Detalle</label>
                    <select name="detalleUE" class="input-ue block w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm text-sm text-white detalle-monto-input">
                        ${Object.keys(ueOptions).map(key => `<option value="${key}" ${key === detailData.ue ? 'selected' : ''}>${ueOptions[key]}</option>`).join('')}
                    </select>
                </div>
                <!-- Efectivos -->
                <div>
                    <label class="block text-xs font-medium text-neutral-400 mb-1">Efectivos</label>
                    <input type="number" step="1" value="${detailData.efectivos || ''}" class="input-efectivos block w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm text-white detalle-monto-input" placeholder="0">
                </div>
                <!-- Total -->
                <div>
                    <label class="block text-xs font-medium text-neutral-400 mb-1">Total</label>
                    <input type="text" value="${totalInitial}" class="input-total block w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm text-white detalle-monto-input" placeholder="0.00">
                </div>
                <!-- Deducciones -->
                <div>
                    <label class="block text-xs font-medium text-neutral-400 mb-1">Deducc.</label>
                    <input type="text" value="${deduccionesInitial}" class="input-deducciones block w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm text-white detalle-monto-input" placeholder="0.00">
                </div>
                <!-- Neto -->
                <div>
                    <label class="block text-xs font-medium text-neutral-400 mb-1">Neto</label>
                    <input type="text" value="${netoFormatted}" readonly class="input-neto block w-full bg-slate-900 border border-slate-600 rounded-md shadow-sm text-green-400 font-bold detalle-monto-input" placeholder="0.00">
                </div>
                <!-- Acción -->
                <div class="flex items-center justify-center">
                    <button type="button" class="remove-detalle-btn text-red-500 hover:text-red-400 p-1 rounded-full hover:bg-slate-700" title="Eliminar Detalle">
                        <i data-feather="x-circle" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
            
            // Asignar eventos a los inputs recién creados
            const inputsToListen = lineDiv.querySelectorAll('.input-total, .input-deducciones');
            inputsToListen.forEach(input => {
                input.addEventListener('blur', handleMoneyInputBlur); // Formatear al salir
                input.addEventListener('focus', handleMoneyInputFocus); // Quitar formato al entrar
                input.addEventListener('input', () => { // Recalcular en cada tecla
                    const line = input.closest('.detalle-linea');
                    if (line) calculateDetalleNeto(line);
                });
            });
            
            // Formatear los campos al crearlos si tienen datos (modo edición)
            if (detailData.total) lineDiv.querySelector('.input-total').value = formatNumber(detailData.total);
            if (detailData.deducciones) lineDiv.querySelector('.input-deducciones').value = formatNumber(detailData.deducciones);

            lineDiv.querySelector('.remove-detalle-btn').addEventListener('click', () => {
                detalleMonetarioContainer.removeChild(lineDiv);
                updateTotalNeto();
            });

            detalleMonetarioContainer.appendChild(lineDiv);
            feather.replace();
            
            // Calcular neto inicial si vienen datos
            if (detailData.total || detailData.deducciones) {
                calculateDetalleNeto(lineDiv);
            }
        }
        
        // --- Funciones de CRUD y Renderizado ---

        /**
         * Configura el listener de onSnapshot para obtener datos en tiempo real.
         */
        function setupSnapshotListener() {
            if (!userId) return; 
            if (unsubscribe) unsubscribe();
            document.getElementById('loading').classList.remove('hidden');

            const q = query(collection(db, collectionPath));
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                allPlanillas = [];
                snapshot.forEach((doc) => {
                    allPlanillas.push({ id: doc.id, ...doc.data() });
                });
                
                // Ordenar por fecha de envío (Trabajo) descendente
                allPlanillas.sort((a, b) => new Date(b.fechaEnvio) - new Date(a.fechaEnvio));
                
                renderPlanillas();
                renderArchiveView();
                
                document.getElementById('loading').classList.add('hidden');
            }, (error) => {
                console.error("Error al obtener datos:", error);
                document.getElementById('loading').textContent = "Error al cargar los datos.";
            });
        }

        /**
         * Renderiza la vista principal aplicando filtros.
         */
        function renderPlanillas() {
            planillasContainer.innerHTML = '';
            const filterForm = document.getElementById('filterForm');
            const formData = new FormData(filterForm);

            const searchExp = formData.get('searchExpediente')?.toLowerCase().trim() || '';
            const filterEst = formData.get('filterEstado') || '';
            const filterStart = formData.get('filterFechaInicio') || '';
            const filterEnd = formData.get('filterFechaFin') || '';

            const filteredPlanillas = allPlanillas.filter(p => {
                const pDate = p.fechaEnvio;
                
                // Buscar en cualquier campo de expediente
                const expMatches = searchExp && (
                    p.expediente?.toLowerCase().includes(searchExp) ||
                    p.expedientePresupuesto?.toLowerCase().includes(searchExp) ||
                    p.expedienteSecretaria?.toLowerCase().includes(searchExp)
                );
                if (searchExp && !expMatches) return false;
                
                // Filtrar por Estado Remisión
                const estado = getEstado(p);
                if (filterEst && estado !== filterEst) return false;
                
                // Filtro de Fechas de Envío (Trabajo)
                if (filterStart && pDate < filterStart) return false;
                if (filterEnd && pDate > filterEnd) return false;
                
                return true;
            });

            if (filteredPlanillas.length === 0) {
                document.getElementById('noResults').classList.remove('hidden');
                planillasContainer.classList.add('hidden');
            } else {
                document.getElementById('noResults').classList.add('hidden');
                planillasContainer.classList.remove('hidden');
                filteredPlanillas.forEach(p => renderPlanillaCard(p, planillasContainer));
            }

            feather.replace();
        }

        /**
         * Crea la tarjeta visual para un registro.
         */
        function renderPlanillaCard(planilla, container) {
            const card = document.createElement('div');
            const isPaid = planilla.checkPagado;
            card.className = `bg-slate-800 shadow-lg rounded-lg overflow-hidden relative border border-slate-700 ${isPaid ? 'paid-indicator' : ''}`;
            card.setAttribute('data-id', planilla.id);
            
            const ueNombre = ueOptions[planilla.unidadEjecutora] || "N/A";
            const estado = getEstado(planilla);
            
            let estadoBadge = '';
            if (estado === 'pagado') estadoBadge = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-700 text-white"><i data-feather="dollar-sign" class="w-4 h-4 inline-block -mt-0.5"></i> Pagado</span>';
            else if (estado === 'secretaria') estadoBadge = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-900/50 text-green-300">En Secretaría</span>';
            else if (estado === 'presupuesto') estadoBadge = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-900/50 text-blue-300">En Presupuesto</span>';
            else estadoBadge = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-900/50 text-yellow-300">En Oficina</span>';

            const tipoDocBadge = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-indigo-900/50 text-indigo-300">${planilla.tipoDocumento || 'Planilla'}</span>`;
            
            // Cálculo del Total General Neto desde los detalles
            let totalGeneralNeto = 0;
            if (planilla.detalleMonetario && planilla.detalleMonetario.length > 0) {
                planilla.detalleMonetario.forEach(d => {
                    totalGeneralNeto += parseFloat(d.neto) || 0;
                });
            }

            // Sección de Valores Monetarios
            let valoresHTML = '';
            if (totalGeneralNeto > 0) {
                 valoresHTML = `
                    <div class="mt-4 pt-4 border-t border-slate-700 flex justify-between items-center">
                        <span class="text-sm text-neutral-400">Total Neto Documento:</span>
                        <strong class="text-xl text-green-400">${formatMoney(totalGeneralNeto)}</strong>
                    </div>
                `;
            }

            // Estado del Personal (Múltiple)
            let estadoPersonalHTML = '';
            if (planilla.personalState && planilla.personalState.length > 0) {
                const badges = planilla.personalState.map(s => {
                    let color = 'bg-neutral-600/50 text-neutral-300';
                    if (s === 'Baja') color = 'bg-red-900/50 text-red-300';
                    else if (s === 'Cambio de Categoría') color = 'bg-yellow-900/50 text-yellow-300';
                    else if (s === 'Activa') color = 'bg-blue-900/50 text-blue-300';
                    return `<span class="px-1 text-xs rounded ${color}">${s}</span>`;
                }).join('');
                
                estadoPersonalHTML = `
                    <div class="mt-3 pt-3 border-t border-slate-700">
                        <h4 class="text-xs font-semibold text-neutral-400 uppercase mb-1">Estado P.</h4>
                        <div class="flex flex-wrap gap-2">${badges}</div>
                    </div>
                `;
            }
            
            // UEs Incluidas (si aplica y hay más de una) - Corregido sin línea verde
            let faIncludesHTML = '';
            if (planilla.unidadEjecutora === 'FA' && planilla.faUeIncludes?.length) {
                // Obtener nombres cortos de UE (Ej: "Ejército", "Aérea")
                const includedUEs = planilla.faUeIncludes.map(ue => ueOptions[ue].split(' - ')[1] || ue).join(', ');
                faIncludesHTML = `
                    <div class="mt-3 pt-3 border-t border-slate-700">
                        <h4 class="text-xs font-semibold text-neutral-400 uppercase mb-1">UEs INCLUIDAS</h4>
                        <p class="text-xs text-indigo-400 italic">${includedUEs}</p>
                    </div>
                `;
            }

            // Observaciones
            let observacionesHTML = '';
            if (planilla.observacionesPersonal) {
                observacionesHTML = `
                    <div class="mt-3 pt-3 border-t border-slate-700">
                        <h4 class="text-xs font-semibold text-neutral-400 uppercase mb-1">Obs.</h4>
                        <p class="text-xs text-neutral-400 italic">${planilla.observacionesPersonal.substring(0, 100)}${planilla.observacionesPersonal.length > 100 ? '...' : ''}</p>
                    </div>
                `;
            }

            // Detalle Monetario
            let detalleMonetarioHTML = '';
            if (planilla.detalleMonetario && planilla.detalleMonetario.length > 0) {
                const detalleRows = planilla.detalleMonetario.map(d => {
                    const ueName = ueOptions[d.ue] || d.ue;
                    const efectivos = d.efectivos ? ` (${d.efectivos} pers)` : '';
                    return `<div class="flex justify-between text-xs text-neutral-400 border-b border-slate-800 py-1"><span>${ueName.split(' - ')[0]} ${efectivos}</span><span class="text-white">${formatMoney(d.neto)}</span></div>`;
                }).join('');

                detalleMonetarioHTML = `
                    <div class="mt-3 pt-3 border-t border-slate-700">
                        <h4 class="text-xs font-semibold text-neutral-400 uppercase mb-1">DETALLE (Neto por UE)</h4>
                        <div class="max-h-24 overflow-y-auto pr-2">
                             ${detalleRows}
                        </div>
                    </div>
                `;
            }

            // Seguimiento
            let seguimientoHTML = '';
            if (planilla.fechaEnvioPresupuesto) {
                seguimientoHTML += `
                    <li class="flex items-center space-x-2 text-sm">
                        <i data-feather="arrow-right-circle" class="w-4 h-4 text-blue-400"></i>
                        <span class="text-neutral-300">Presupuesto: <strong class="text-white">${planilla.fechaEnvioPresupuesto}</strong> (Exp: ${planilla.expedientePresupuesto || 'N/A'})</span>
                    </li>`;
            }
            if (planilla.fechaEnvioSecretaria) {
                seguimientoHTML += `
                    <li class="flex items-center space-x-2 text-sm">
                        <i data-feather="check-circle" class="w-4 h-4 text-green-400"></i>
                        <span class="text-neutral-300">Secretaría: <strong class="text-white">${planilla.fechaEnvioSecretaria}</strong> (Exp: ${planilla.expedienteSecretaria || 'N/A'})</span>
                    </li>`;
            }
            if (seguimientoHTML === '') {
                seguimientoHTML = `<li class="flex items-center space-x-2 text-sm text-neutral-500 italic"><i data-feather="info" class="w-4 h-4"></i><span>Aún en oficina</span></li>`;
            }

            card.innerHTML = `
                <div class="p-5">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-lg font-semibold text-white">${planilla.expediente}</h3>
                            <!-- Corregido a Ref. Planilla y muestra solo YYYY-MM -->
                            <p class="text-sm text-neutral-400">Ref. Planilla: <strong class="text-white">${planilla.fechaPlanilla || 'N/A'}</strong></p>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            ${tipoDocBadge}
                            ${estadoBadge}
                        </div>
                    </div>
                    
                    <!-- Cuerpo de la tarjeta -->
                    <div class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm mt-4 pb-2 border-b border-slate-700">
                        <div class="flex items-center space-x-2">
                            <i data-feather="map-pin" class="w-4 h-4 text-neutral-500"></i>
                            <span class="text-neutral-400">UE Principal: <strong class="text-white" title="${ueNombre}">${ueNombre}</strong></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i data-feather="calendar" class="w-4 h-4 text-neutral-500"></i>
                            <span class="text-neutral-400">Elaboración: <strong class="text-white">${planilla.fechaEnvio}</strong></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i data-feather="package" class="w-4 h-4 text-neutral-500"></i>
                            <span class="text-neutral-400">Objeto: <strong class="text-white">${planilla.objetoGasto}</strong></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i data-feather="layers" class="w-4 h-4 text-neutral-500"></i>
                            <span class="text-neutral-400">Planilla: <strong class="text-white">${planilla.tipoPlanilla}</strong></span>
                        </div>
                        <!-- "Deducción Global" eliminada de la vista -->
                    </div>

                    <!-- Estado Personal y UEs Incluidas -->
                    ${estadoPersonalHTML}
                    ${faIncludesHTML}

                    <!-- Detalle Monetario y Total Neto -->
                    ${detalleMonetarioHTML}
                    ${valoresHTML}
                    
                    ${observacionesHTML}

                    <!-- Seguimiento -->
                    <div class="mt-4 pt-4 border-t border-slate-700">
                        <h4 class="text-xs font-semibold text-neutral-400 uppercase mb-2">Historial de Remisiones</h4>
                        <ul class="space-y-2">
                            ${seguimientoHTML}
                        </ul>
                    </div>
                </div>
                <div class="absolute top-3 right-3 flex space-x-2">
                    <button class="edit-btn text-indigo-400 hover:text-indigo-300 p-1 rounded-full hover:bg-slate-700" data-id="${planilla.id}" title="Editar Registro">
                        <i data-feather="edit-3" class="w-4 h-4"></i>
                    </button>
                    <button class="delete-btn text-red-500 hover:text-red-400 p-1 rounded-full hover:bg-slate-700" data-id="${planilla.id}" title="Eliminar">
                        <i data-feather="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            container.appendChild(card);
        }
        
        /**
         * Renderiza la vista de archivo por año y mes.
         */
        function renderArchiveView() {
            archiveContainer.innerHTML = '';
            
            const grouped = allPlanillas.reduce((acc, p) => {
                try {
                    // Usamos la fecha de envío (trabajo) para el archivo
                    const date = new Date(p.fechaEnvio + 'T00:00:00'); 
                    if (isNaN(date)) throw new Error("Invalid date");
                    const year = date.getUTCFullYear().toString();
                    const month = monthNames[date.getUTCMonth()];
                    
                    if (!acc[year]) acc[year] = {};
                    if (!acc[year][month]) acc[year][month] = [];
                    acc[year][month].push(p);
                } catch(e) {
                    console.error("Fecha inválida:", p.fechaEnvio, p.id);
                }
                return acc;
            }, {});

            const sortedYears = Object.keys(grouped).sort().reverse(); 

            if (sortedYears.length === 0) {
                archiveContainer.innerHTML = `<p class="text-center text-neutral-500 py-10">No hay registros para archivar.</p>`;
                return;
            }

            for (const year of sortedYears) {
                const yearDiv = document.createElement('div');
                yearDiv.className = 'year-group';
                
                let yearHTML = `<h3 class="text-2xl font-semibold text-white mb-6 border-b border-slate-700 pb-3">${year}</h3>`;
                // Ordenar meses numéricamente
                const sortedMonths = Object.keys(grouped[year]).sort(); 
                
                let monthsHTML = '<div class="month-group space-y-8">';
                for (const month of sortedMonths) {
                    const monthName = month.substring(3); // Solo el nombre del mes
                    monthsHTML += `
                        <div>
                            <h4 class="text-xl font-medium text-indigo-300 mb-4" data-month-key="${monthName}">${monthName}</h4>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Contenedor para tarjetas de este mes -->
                            </div>
                        </div>
                    `;
                }
                monthsHTML += '</div>';
                yearDiv.innerHTML = yearHTML + monthsHTML;
                
                archiveContainer.appendChild(yearDiv);

                for (const month of sortedMonths) {
                    const monthName = month.substring(3);
                    const cardContainer = yearDiv.querySelector(`h4[data-month-key="${monthName}"] + div.grid`);
                    
                    if (cardContainer) {
                        // Ordenar planillas dentro del mes por fecha de envío descendente
                        grouped[year][month].sort((a, b) => new Date(b.fechaEnvio) - new Date(a.fechaEnvio));
                        grouped[year][month].forEach(p => renderPlanillaCard(p, cardContainer));
                    }
                }
            }
            feather.replace();
        }

        // --- Funciones de Formulario (Agregar/Editar) ---

        /**
         * Prepara el formulario para editar un registro existente.
         * ¡CORREGIDO!
         */
        function prepareFormForEdit(registroId) {
            const registro = allPlanillas.find(p => p.id === registroId);
            if (!registro) {
                console.error("No se encontró el registro para editar.");
                return;
            }

            // 1. Navegar a la vista de agregar/editar
            handleNavClick({ preventDefault: () => {}, currentTarget: document.querySelector('a[data-view="view-agregar"]') });

            // 2. Llenar campos de un solo valor (incluyendo inputs de fecha y texto)
            for (const key in registro) {
                const input = document.getElementById(key);
                if (input && input.type !== 'checkbox' && input.type !== 'radio') {
                    input.value = registro[key] || '';
                }
            }
            
            // 3. Llenar Checkboxes de Estado Personal
            personalStateInputs.forEach(input => {
                input.checked = registro.personalState?.includes(input.value) || false;
            });
            
            // 4. Llenar campos de Seguimiento (Checkboxes y Fechas/Expedientes)
            checkPresupuesto.checked = !!registro.fechaEnvioPresupuesto;
            toggleFields(fieldsPresupuesto, checkPresupuesto.checked);
            document.getElementById('fechaEnvioPresupuesto').value = registro.fechaEnvioPresupuesto || '';
            document.getElementById('expedientePresupuesto').value = registro.expedientePresupuesto || '';

            checkSecretaria.checked = !!registro.fechaEnvioSecretaria;
            toggleFields(fieldsSecretaria, checkSecretaria.checked);
            document.getElementById('fechaEnvioSecretaria').value = registro.fechaEnvioSecretaria || '';
            document.getElementById('expedienteSecretaria').value = registro.expedienteSecretaria || '';
            
            // 5. Checkboxes FA (activar sección y chequear UEs)
            if (registro.unidadEjecutora === 'FA') {
                 faCategoriesSection.classList.remove('hidden');
                 faUeIncludesInputs.forEach(input => {
                     input.checked = registro.faUeIncludes?.includes(input.value) || false;
                 });
            } else {
                 faCategoriesSection.classList.add('hidden');
            }
            
            // 6. CAMBIO: Checkboxes de Pagos -> Radio Buttons
            if (registro.checkPagado) {
                document.getElementById('radioPagado').checked = true;
            } else {
                document.getElementById('radioNoPagado').checked = true;
            }
            
            // 7. Cargar Detalle Monetario Dinámico
            detalleMonetarioContainer.innerHTML = '';
            if (registro.detalleMonetario && Array.isArray(registro.detalleMonetario) && registro.detalleMonetario.length > 0) {
                registro.detalleMonetario.forEach(detail => createDetalleMonetarioLine(detail));
            } else {
                 createDetalleMonetarioLine(); // Dejar una línea vacía por defecto
            }
            updateTotalNeto();

            // 8. Poner el ID y cambiar UI
            registroIdInput.value = registroId;
            formTitle.textContent = 'Editar Registro';
            submitButtonText.textContent = 'Actualizar Registro';
            cancelEditButton.classList.remove('hidden');
        }

        /**
         * Restablece el formulario a su estado inicial.
         */
        function resetForm() {
            addForm.reset();
            registroIdInput.value = '';
            
            toggleFields(fieldsPresupuesto, false);
            toggleFields(fieldsSecretaria, false);
            faCategoriesSection.classList.add('hidden');
            faUeIncludesInputs.forEach(input => input.checked = false); // Limpiar checkboxes FA

            // Limpiar Estado Personal
            personalStateInputs.forEach(input => input.checked = false);

            // Limpiar Detalle Monetario
            detalleMonetarioContainer.innerHTML = '';
            createDetalleMonetarioLine(); // Dejar una línea vacía por defecto
            updateTotalNeto();
            
            // CAMBIO: Default a "No Pagado"
            document.getElementById('radioNoPagado').checked = true;

            formTitle.textContent = 'Agregar Nuevo Registro';
            submitButtonText.textContent = 'Guardar Registro';
            cancelEditButton.classList.add('hidden');
        }

        /**
         * Maneja el envío y actualización del formulario.
         */
        async function handleAddFormSubmit(e) {
            e.preventDefault();
            if (!userId) return; 
            
            const docId = registroIdInput.value;
            const formData = new FormData(addForm);
            
            // Capturar Estado de Personal (checkboxes)
            const personalState = Array.from(personalStateInputs).filter(input => input.checked).map(input => input.value);
            
            // Capturar UEs Incluidas (solo si es FA)
            let faUeIncludes = [];
            if (formData.get('unidadEjecutora') === 'FA') {
                faUeIncludes = Array.from(faCategoriesSection.querySelectorAll('input[name="faUeIncludes"]:checked')).map(input => input.value);
            }
            
            // Capturar Detalle Monetario Dinámico
            const detalleMonetario = [];
            const detailLines = detalleMonetarioContainer.querySelectorAll('.detalle-linea');
            detailLines.forEach(line => {
                const ue = line.querySelector('.input-ue').value;
                const efectivos = parseFloat(line.querySelector('.input-efectivos').value) || 0;
                
                // Reemplazar comas para almacenar como número puro
                const total = parseFloat(unformatNumber(line.querySelector('.input-total').value)) || 0;
                const deducciones = parseFloat(unformatNumber(line.querySelector('.input-deducciones').value)) || 0;
                const neto = parseFloat(unformatNumber(line.querySelector('.input-neto').value)) || 0;
                
                if (ue) { // Solo guarda líneas con una UE seleccionada
                    detalleMonetario.push({
                        ue: ue,
                        efectivos: efectivos,
                        total: total,
                        deducciones: deducciones,
                        neto: neto
                    });
                }
            });

            // CAMBIO: Capturar valor de Radio Button
            const estadoPagoRadio = document.querySelector('input[name="estadoPago"]:checked');
            const checkPagado = estadoPagoRadio ? estadoPagoRadio.value === 'pagado' : false;

            const registroData = {
                // Fechas Clave
                fechaPlanilla: formData.get('fechaPlanilla'), // YYYY-MM
                fechaEnvio: formData.get('fechaEnvio'), // YYYY-MM-DD
                
                // Datos Principales
                tipoDocumento: formData.get('tipoDocumento'),
                expediente: formData.get('expediente'),
                unidadEjecutora: formData.get('unidadEjecutora'), // UE Principal
                objetoGasto: formData.get('objetoGasto'),
                tipoPlanilla: formData.get('tipoPlanilla'),
                
                // Control de Personal (Nuevo formato)
                personalState: personalState, // Array de estados seleccionados
                faUeIncludes: faUeIncludes, // UEs incluidas si es FA
                observacionesPersonal: formData.get('observacionesPersonal') || null,

                // Seguimiento de Remisiones
                fechaEnvioPresupuesto: checkPresupuesto.checked ? formData.get('fechaEnvioPresupuesto') : null,
                expedientePresupuesto: checkPresupuesto.checked ? formData.get('expedientePresupuesto') : null,
                
                fechaEnvioSecretaria: checkSecretaria.checked ? formData.get('fechaEnvioSecretaria') : null,
                expedienteSecretaria: checkSecretaria.checked ? formData.get('expedienteSecretaria') : null,
                
                // Control Monetario Dinámico
                detalleMonetario: detalleMonetario,

                // Control de Pago Global (ahora desde radio)
                checkPagado: checkPagado,
            };
            
            try {
                if (docId) {
                    await updateDoc(doc(db, collectionPath, docId), registroData);
                } else {
                    registroData.createdAt = Timestamp.now();
                    await addDoc(collection(db, collectionPath), registroData);
                }

                resetForm();
                handleNavClick({ preventDefault: () => {}, currentTarget: document.querySelector('a[data-view="view-dashboard"]') });
            } catch (error) {
                console.error(`Error al ${docId ? 'actualizar' : 'agregar'} documento: `, error);
            }
        }
        
        // --- Funciones de Autenticación y Carga ---
        
        function initializeFirebase() {
            try {
                const loginScreen = document.getElementById('login-screen');
                const mainApp = document.getElementById('main-app');
                const userPhoto = document.getElementById('user-photo');
                const userName = document.getElementById('user-name');
                const userEmail = document.getElementById('user-email');
                const loginError = document.getElementById('login-error');

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                provider = new GoogleAuthProvider();
                setLogLevel('Debug');
                
                // Crear primera línea de detalle monetario
                createDetalleMonetarioLine();

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userPhoto.src = user.photoURL || 'https://placehold.co/40x40/606060/FFFFFF?text=?';
                        userName.textContent = user.displayName || 'Usuario';
                        userEmail.textContent = user.email;
                        collectionPath = `planillas/${userId}/registros`;
                        
                        mainApp.classList.remove('hidden');
                        loginScreen.classList.add('hidden');
                        loginError.textContent = '';
                        
                        setupSnapshotListener();
                    } else {
                        userId = null;
                        if (unsubscribe) unsubscribe();
                        mainApp.classList.add('hidden');
                        loginScreen.classList.remove('hidden');
                    }
                });
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                document.getElementById('login-error').textContent = "Error al conectar con Firebase.";
            }
        }

        async function handleLogin() {
            try {
                document.getElementById('login-error').textContent = '';
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error al iniciar sesión:", error);
                document.getElementById('login-error').textContent = "Error al iniciar sesión. Intenta de nuevo.";
            }
        }

        async function handleLogout() {
            try { await signOut(auth); } 
            catch (error) { console.error("Error al cerrar sesión:", error); }
        }

        // --- Event Listeners Globales ---
        
        function handleCardActionClick(e) {
            let target = e.target;
            
            // Buscar el botón (edit-btn o delete-btn) subiendo por el DOM
            while (target != null && !target.classList.contains('edit-btn') && !target.classList.contains('delete-btn')) {
                target = target.parentElement;
            }

            if (target && target.classList.contains('edit-btn')) {
                e.preventDefault();
                e.stopPropagation();
                prepareFormForEdit(target.dataset.id); // ¡Llamada corregida!
            } else if (target && target.classList.contains('delete-btn')) {
                e.preventDefault();
                e.stopPropagation();
                handleDeleteClick(target.dataset.id);
            }
        }

        async function handleDeleteClick(docId) {
            if (!userId) return; 

            if (await showDeleteConfirmation()) {
                try {
                    await deleteDoc(doc(db, collectionPath, docId));
                } catch (error) {
                    console.error("Error al eliminar documento:", error);
                }
            }
        }

        function showDeleteConfirmation() {
            return new Promise((resolve) => {
                const modalOverlay = document.getElementById('customModal');
                document.getElementById('modal-title').textContent = 'Confirmar Eliminación';
                document.getElementById('modal-message').textContent = '¿Estás seguro de que deseas eliminar este registro? Esta acción no se puede deshacer.';
                
                modalOverlay.classList.remove('hidden');
                modalOverlay.classList.add('flex');

                document.getElementById('modal-confirm').onclick = () => {
                    modalOverlay.classList.add('hidden');
                    modalOverlay.classList.remove('flex');
                    resolve(true);
                };
                document.getElementById('modal-cancel').onclick = () => {
                    modalOverlay.classList.add('hidden');
                    modalOverlay.classList.remove('flex');
                    resolve(false);
                };
            });
        }
        
        function toggleFaUeIncludesSection() {
            if (unidadEjecutoraSelect.value === 'FA') {
                faCategoriesSection.classList.remove('hidden');
            } else {
                faCategoriesSection.classList.add('hidden');
                // Limpiar los checkboxes al ocultar
                faUeIncludesInputs.forEach(input => input.checked = false);
            }
        }

        // Asignación de Eventos al cargar el script
        window.onload = function() {
            initializeFirebase();
            feather.replace();

            // Formulario y Filtros
            document.getElementById('login-button').addEventListener('click', handleLogin);
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            navLinks.forEach(link => link.addEventListener('click', handleNavClick));
            addForm.addEventListener('submit', handleAddFormSubmit);
            cancelEditButton.addEventListener('click', (e) => { e.preventDefault(); resetForm(); handleNavClick({ preventDefault: () => {}, currentTarget: document.querySelector('a[data-view="view-dashboard"]') }); });

            // Eventos en el formulario de agregar/editar
            unidadEjecutoraSelect.addEventListener('change', toggleFaUeIncludesSection);
            checkPresupuesto.addEventListener('change', (e) => toggleFields(fieldsPresupuesto, e.target.checked));
            checkSecretaria.addEventListener('change', (e) => toggleFields(fieldsSecretaria, e.target.checked));
            
            // Eventos de Control Monetario Dinámico
            addDetalleBtn.addEventListener('click', () => createDetalleMonetarioLine());

            // Delegación de eventos de la vista principal y archivo (¡Corregido!)
            planillasContainer.addEventListener('click', handleCardActionClick);
            archiveContainer.addEventListener('click', handleCardActionClick);
            
            document.getElementById('filterButton').addEventListener('click', (e) => { e.preventDefault(); renderPlanillas(); });
            document.getElementById('clearFilterButton').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('filterForm').reset(); renderPlanillas(); });
        };
    </script>
</body>
</html>