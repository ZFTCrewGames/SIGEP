<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGEP - Gestión de Planillas</title>
    
    <!-- FAVICON (Nuevo) -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjOGI5MmY3IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgY2xhc3M9ImZlYXRoZXIgZmVhdGhlci1zaGllbGQiPjxwYXRoIGQ9Ik0xMiAyMmM1LjUyMyAwIDEwLTQuNDc3IDEwLTEwUzE3LjUyMyAyIDEyIDIgMiA2LjQ3NyAyIDEyczQuNDc3IDEwIDEwIDEwek0xMiA2djYiLz48cGF0aCBkPSJNMTIgMThsLTMtMy4wMCIvPjxwYXRoIGQ9Ik0xMiAxOGwzLTMuMDAiLz48cGF0aCBkPSJNMTIgNnY2IiAvPjxwYXRoIGQ9Ik0xMiAxMmwtMyAzLjAwIiAvPjxwYXRoIGQ9Ik0xMiAxMmwzIDMuMDAiIC8+PC9zdmc+">

    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Iconos (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        /* Estilos para que los selects se vean consistentes en modo oscuro */
        select, input[type="date"] {
            appearance: none;
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        select {
             background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 20 20"><path stroke="%239CA3AF" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m6 8 4 4 4-4"/></svg>');
        }
        input[type="date"] {
            color-scheme: dark;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Scrollbar oscuro */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .view-section { display: none; }
        .view-section.active { display: block; }
        
        .loader {
            border-top-color: #4f46e5; /* indigo-600 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-neutral-200">

    <!-- PANTALLA DE LOGIN (Visible por defecto) -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-900">
        <div class="bg-slate-800 p-8 rounded-lg shadow-xl text-center w-full max-w-sm">
            <i data-feather="file-text" class="w-12 h-12 text-indigo-400 mx-auto mb-4"></i>
            <h1 class="text-2xl font-bold text-white mb-2">SIGEP</h1>
            <p class="text-neutral-400 mb-6">Sistema de Gestión de Planillas</p>
            <button id="login-button" class="w-full inline-flex justify-center items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-800">
                <!-- Icono de Google SVG -->
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 20a10 10 0 1 1 0-20 10 10 0 0 1 0 20zM7.188 5.031C6.918 6.007 6.66 7.438 6.66 8.5c0 .01 0 .02-.002.03a11.12 11.12 0 0 0 .666 3.61c.002.007.003.014.005.021a6.979 6.979 0 0 0 1.22 1.939c.13.14.264.275.4.406a4.414 4.414 0 0 0 1.09 1.51 4.5 4.5 0 0 0 5.432-1.513c.132-.136.265-.274.396-.412a6.977 6.977 0 0 0 1.22-1.938c.002-.007.003-.014.005-.021a11.12 11.12 0 0 0 .666-3.61c0-.01 0-.02-.002-.03c0-1.062-.258-2.493-.528-3.469a.5.5 0 0 0-.943.264c.248.892.49 2.21.49 3.205c0 .007 0 .013-.002.02a9.125 9.125 0 0 1-.55 2.97c-.003.013-.006.026-.01.039a4.982 4.982 0 0 1-.87 1.38c-.125.132-.255.26-.388.384a2.498 2.498 0 0 1-3.03 0c-.133-.124-.263-.252-.388-.384a4.982 4.982 0 0 1-.87-1.38c-.003-.013-.006.026-.01-.039a9.125 9.125 0 0 1-.55-2.97c0-.007 0 .013-.002-.02c0-.995.242-2.313.49-3.205a.5.5 0 0 0-.943-.264z"></path></svg>
                Iniciar Sesión con Google
            </button>
            <p id="login-error" class="text-red-400 text-sm mt-4"></p>
        </div>
    </div>

    <!-- INTERFAZ PRINCIPAL (Oculta por defecto) -->
    <div id="main-app" class="hidden">
        <div class="flex h-screen bg-gray-900">
            <!-- Sidebar -->
            <aside class="w-64 flex-shrink-0 bg-slate-800 flex flex-col">
                <div class="h-16 flex items-center justify-center px-4 shadow-md shadow-slate-900/20">
                    <i data-feather="shield" class="w-6 h-6 text-indigo-400 mr-3"></i>
                    <h1 class="text-xl font-semibold text-white">SIGEP</h1>
                </div>
                <nav class="flex-1 overflow-y-auto mt-4 space-y-2 px-3">
                    <a href="#" data-view="view-dashboard" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md text-white bg-indigo-600">
                        <i data-feather="grid" class="w-5 h-5 mr-3"></i>
                        Dashboard
                    </a>
                    <a href="#" data-view="view-archive" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md text-neutral-300 hover:bg-slate-700 hover:text-white">
                        <i data-feather="archive" class="w-5 h-5 mr-3"></i>
                        Archivo por Fecha
                    </a>
                    <a href="#" data-view="view-agregar" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md text-neutral-300 hover:bg-slate-700 hover:text-white">
                        <i data-feather="plus-circle" class="w-5 h-5 mr-3"></i>
                        Agregar Registro
                    </a>
                </nav>
                <div class="p-4 border-t border-slate-700">
                    <!-- Info de Usuario -->
                    <div class="flex items-center">
                        <img id="user-photo" class="h-10 w-10 rounded-full" src="https://placehold.co/40x40/606060/FFFFFF?text=?" alt="User photo">
                        <div class="ml-3">
                            <p id="user-name" class="text-sm font-medium text-white">Cargando...</p>
                            <p id="user-email" class="text-xs text-neutral-400">...</p>
                        </div>
                    </div>
                    <button id="logout-button" class="w-full text-left mt-4 flex items-center px-3 py-2 text-sm font-medium rounded-md text-neutral-300 hover:bg-slate-700 hover:text-white">
                        <i data-feather="log-out" class="w-5 h-5 mr-3"></i>
                        Cerrar Sesión
                    </button>
                </div>
            </aside>

            <!-- Contenido Principal -->
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
                
                <!-- VISTA: DASHBOARD (Ver Registros) -->
                <section id="view-dashboard" class="view-section active">
                    <h2 class="text-2xl font-semibold text-white mb-6">Dashboard de Registros</h2>
                    
                    <!-- Sección de Filtros -->
                    <form id="filterForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-slate-800 rounded-lg shadow-lg">
                        <div>
                            <label for="searchExpediente" class="block text-sm font-medium text-neutral-300">Buscar por Expediente</label>
                            <input type="text" id="searchExpediente" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white" placeholder="Buscar...">
                        </div>
                        <div>
                            <label for="filterEstado" class="block text-sm font-medium text-neutral-300">Filtrar por Estado</label>
                            <select id="filterEstado" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                <option value="">Todos</option>
                                <option value="oficina">En Oficina</option>
                                <option value="presupuesto">En Presupuesto</option>
                                <option value="secretaria">En Secretaría</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterFechaInicio" class="block text-sm font-medium text-neutral-300">Fecha Desde</label>
                            <input type="date" id="filterFechaInicio" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                        </div>
                        <div>
                            <label for="filterFechaFin" class="block text-sm font-medium text-neutral-300">Fecha Hasta</label>
                            <input type="date" id="filterFechaFin" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                        </div>
                        <div class="sm:col-span-2 lg:col-span-4 flex items-center space-x-2">
                            <button type="button" id="filterButton" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-800">
                                Filtrar
                            </button>
                            <button type="button" id="clearFilterButton" class="w-full inline-flex justify-center py-2 px-4 border border-slate-600 shadow-sm text-sm font-medium rounded-md text-neutral-200 bg-slate-700 hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-800">
                                Limpiar Filtros
                            </button>
                        </div>
                    </form>

                    <!-- Contenedor de Tarjetas -->
                    <div id="loading" class="flex justify-center items-center py-10">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-600 h-12 w-12"></div>
                        <p class="ml-4 text-neutral-400">Cargando datos...</p>
                    </div>

                    <div id="planillasContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Las tarjetas se insertarán aquí dinámicamente -->
                    </div>
                    <p id="noResults" class="text-center text-neutral-500 py-10 hidden">No se encontraron registros que coincidan con los filtros.</p>
                </section>

                <!-- VISTA: ARCHIVO POR FECHA -->
                <section id="view-archive" class="view-section">
                    <h2 class="text-2xl font-semibold text-white mb-6">Archivo por Fecha</h2>
                    <div id="archiveContainer" class="space-y-12">
                        <!-- El contenido se genera dinámicamente -->
                    </div>
                </section>


                <!-- VISTA: AGREGAR REGISTRO -->
                <section id="view-agregar" class="view-section">
                    <h2 class="text-2xl font-semibold text-white mb-6">Agregar Nuevo Registro</h2>
                    <div class="bg-slate-800 p-6 rounded-lg shadow-lg max-w-4xl mx-auto">
                        <form id="addForm" class="space-y-6">
                            
                            <!-- Sección Datos Principales -->
                            <div>
                                <h3 class="text-lg font-medium text-indigo-300 border-b border-slate-700 pb-2 mb-4">Datos Principales</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label for="tipoDocumento" class="block text-sm font-medium text-neutral-300">Tipo de Documento</label>
                                        <select id="tipoDocumento" name="tipoDocumento" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                            <option value="Planilla">Planilla</option>
                                            <option value="Informe">Informe</option>
                                            <option value="Remisión">Remisión</option>
                                            <!-- Opción Nueva -->
                                            <option value="Solicitud">Solicitud</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="expediente" class="block text-sm font-medium text-neutral-300">N° de Expediente (Principal)</label>
                                        <input type="text" id="expediente" name="expediente" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white" placeholder="Ej: 2025-001-A">
                                    </div>
                                    <div>
                                        <label for="fechaEnvio" class="block text-sm font-medium text-neutral-300">Fecha de Envío (Inicial)</label>
                                        <input type="date" id="fechaEnvio" name="fechaEnvio" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
                                    <div>
                                        <label for="unidadEjecutora" class="block text-sm font-medium text-neutral-300">Unidad Ejecutora</label>
                                        <select id="unidadEjecutora" name="unidadEjecutora" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                            <option value="11">11 - Fuerza del Ejército</option>
                                            <option value="12">12 - Fuerza Aérea</option>
                                            <option value="13">13 - Fuerza Naval</option>
                                            <option value="14">14 - Estado Mayor Conjunto</option>
                                            <option value="15">15 - Hospital Militar</option>
                                            <option value="32">32 - PMOP</option>
                                            <option value="99">99 - Otra</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="objetoGasto" class="block text-sm font-medium text-neutral-300">Objeto de Gasto</label>
                                        <select id="objetoGasto" name="objetoGasto" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                            <option value="Haberes">Haberes</option>
                                            <option value="Vacaciones">Vacaciones</option>
                                            <option value="Bonificación">Bonificación</option>
                                            <option value="Décimo Tercero">Décimo Tercero</option>
                                            <option value="Décimo Cuarto">Décimo Cuarto</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="tipoTropa" class="block text-sm font-medium text-neutral-300">Tipo de Tropa</label>
                                        <select id="tipoTropa" name="tipoTropa" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                            <option value="Tropa Activa">Tropa Activa</option>
                                            <option value="Tropa Baja">Tropa Baja</option>
                                            <option value="N/A">N/A</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="tipoPlanilla" class="block text-sm font-medium text-neutral-300">Tipo de Planilla</label>
                                        <select id="tipoPlanilla" name="tipoPlanilla" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                            <option value="Ordinaria">Ordinaria</option>
                                            <option value="Complementaria">Complementaria</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sección Seguimiento -->
                            <div>
                                <h3 class="text-lg font-medium text-indigo-300 border-b border-slate-700 pb-2 mb-4">Seguimiento (Opcional)</h3>
                                <div class="space-y-4">
                                    <!-- Presupuesto -->
                                    <div class="bg-slate-700/50 p-4 rounded-lg">
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="checkPresupuesto" class="h-4 w-4 text-indigo-600 rounded border-slate-500 focus:ring-indigo-500">
                                            <span class="text-md font-medium text-white">Enviado a Presupuesto</span>
                                        </label>
                                        <div id="fieldsPresupuesto" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3 hidden">
                                            <div>
                                                <label for="fechaEnvioPresupuesto" class="block text-sm font-medium text-neutral-300">Fecha de Envío a Presupuesto</label>
                                                <input type="date" id="fechaEnvioPresupuesto" name="fechaEnvioPresupuesto" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                            </div>
                                            <div>
                                                <label for="expedientePresupuesto" class="block text-sm font-medium text-neutral-300">N° Expediente de Presupuesto</label>
                                                <input type="text" id="expedientePresupuesto" name="expedientePresupuesto" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white" placeholder="Ej: P-2025-150">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Secretaría -->
                                    <div class="bg-slate-700/50 p-4 rounded-lg">
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" id="checkSecretaria" class="h-4 w-4 text-indigo-600 rounded border-slate-500 focus:ring-indigo-500">
                                            <span class="text-md font-medium text-white">Enviado a Secretaría</span>
                                        </label>
                                        <div id="fieldsSecretaria" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3 hidden">
                                            <div>
                                                <label for="fechaEnvioSecretaria" class="block text-sm font-medium text-neutral-300">Fecha de Envío a Secretaría</label>
                                                <input type="date" id="fechaEnvioSecretaria" name="fechaEnvioSecretaria" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white">
                                            </div>
                                            <div>
                                                <label for="expedienteSecretaria" class="block text-sm font-medium text-neutral-300">N° Expediente de Secretaría</label>
                                                <input type="text" id="expedienteSecretaria" name="expedienteSecretaria" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white" placeholder="Ej: S-2025-300">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sección Valores Monetarios -->
                            <div>
                                <h3 class="text-lg font-medium text-indigo-300 border-b border-slate-700 pb-2 mb-4">Valores Monetarios (Opcional)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label for="valorTotal" class="block text-sm font-medium text-neutral-300">Valor Total de Planilla</label>
                                        <input type="number" id="valorTotal" name="valorTotal" step="0.01" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white" placeholder="0.00">
                                    </div>
                                    <div>
                                        <label for="valorDeducciones" class="block text-sm font-medium text-neutral-300">Deducciones</Glabel>
                                        <input type="number" id="valorDeducciones" name="valorDeducciones" step="0.01" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-white" placeholder="0.00">
                                    </div>
                                    <div>
                                        <label for="valorNeto" class="block text-sm font-medium text-neutral-300">Neto a Pagar</label>
                                        <input type="text" id="valorNeto" name="valorNeto" readonly class="mt-1 block w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-md shadow-sm sm:text-sm text-green-400 font-bold" placeholder="0.00">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Botón de Enviar -->
                            <div class="pt-4">
                                <button type="submit" class="w-full inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-800">
                                    Guardar Registro
                                </button>
                            </div>
                        </form>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            deleteDoc, 
            collection, 
            onSnapshot, 
            query,
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyA9l_RrRwP8gvmrvhEBpAV0aV4v9sMG-UA",
            authDomain: "sigep-planillas.firebaseapp.com",
            projectId: "sigep-planillas",
            storageBucket: "sigep-planillas.firebasestorage.app",
            messagingSenderId: "707813910405",
            appId: "1:707813910405:web:2d878a07039d0bbaa046ec"
        };
        
        // --- Variables Globales ---
        let app, auth, db, provider, userId, collectionPath;
        let allPlanillas = [];
        let unsubscribe;

        // --- Mapas y Constantes ---
        const ueMap = {
            "11": "11 - Fuerza del Ejército", "12": "12 - Fuerza Aérea",
            "13": "13 - Fuerza Naval", "14": "14 - Estado Mayor Conjunto",
            "15": "15 - Hospital Militar", "32": "32 - PMOP",
            "99": "99 - Otra"
        };
        const monthNames = [
            "01-Enero", "02-Febrero", "03-Marzo", "04-Abril", "05-Mayo", "06-Junio",
            "07-Julio", "08-Agosto", "09-Septiembre", "10-Octubre", "11-Noviembre", "12-Diciembre"
        ];

        // --- Selectores del DOM ---
        const loginScreen = document.getElementById('login-screen');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const mainApp = document.getElementById('main-app');
        const logoutButton = document.getElementById('logout-button');
        const userPhoto = document.getElementById('user-photo');
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');
        const navLinks = document.querySelectorAll('.nav-link');
        const viewSections = document.querySelectorAll('.view-section');
        const addForm = document.getElementById('addForm');
        const loading = document.getElementById('loading');
        const planillasContainer = document.getElementById('planillasContainer');
        const archiveContainer = document.getElementById('archiveContainer');
        const noResults = document.getElementById('noResults');
        const filterForm = document.getElementById('filterForm');
        const searchExpediente = document.getElementById('searchExpediente');
        const filterEstado = document.getElementById('filterEstado');
        const filterFechaInicio = document.getElementById('filterFechaInicio');
        const filterFechaFin = document.getElementById('filterFechaFin');
        const filterButton = document.getElementById('filterButton');
        const clearFilterButton = document.getElementById('clearFilterButton');

        // Formulario "Agregar"
        const checkPresupuesto = document.getElementById('checkPresupuesto');
        const fieldsPresupuesto = document.getElementById('fieldsPresupuesto');
        const checkSecretaria = document.getElementById('checkSecretaria');
        const fieldsSecretaria = document.getElementById('fieldsSecretaria');
        const valorTotal = document.getElementById('valorTotal');
        const valorDeducciones = document.getElementById('valorDeducciones');
        const valorNeto = document.getElementById('valorNeto');

        // --- Funciones Principales ---

        /**
         * Inicializa Firebase y configura los listeners de autenticación.
         */
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                provider = new GoogleAuthProvider();
                setLogLevel('Debug');

                onAuthStateChanged(auth, (user) => {
                    if (user) handleLoginSuccess(user);
                    else handleLogoutSuccess();
                });
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                loginError.textContent = "Error al conectar con Firebase.";
            }
        }

        /**
         * Maneja el éxito del inicio de sesión.
         */
        function handleLoginSuccess(user) {
            userId = user.uid;
            userPhoto.src = user.photoURL || 'https://placehold.co/40x40/606060/FFFFFF?text=?';
            userName.textContent = user.displayName || 'Usuario';
            userEmail.textContent = user.email;
            collectionPath = `planillas/${userId}/registros`;
            
            mainApp.classList.remove('hidden');
            loginScreen.classList.add('hidden');
            loginError.textContent = '';
            
            setupSnapshotListener();
        }

        /**
         * Maneja el cierre de sesión.
         */
        function handleLogoutSuccess() {
            userId = null;
            collectionPath = null;
            if (unsubscribe) unsubscribe();
            allPlanillas = [];
            planillasContainer.innerHTML = '';
            
            mainApp.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            userPhoto.src = 'https://placehold.co/40x40/606060/FFFFFF?text=?';
            userName.textContent = '...';
            userEmail.textContent = '...';
        }

        /**
         * Inicia el pop-up de inicio de sesión con Google.
         */
        async function handleLogin() {
            try {
                loginError.textContent = '';
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error al iniciar sesión:", error);
                loginError.textContent = "Error al iniciar sesión. Intenta de nuevo.";
            }
        }

        /**
         * Cierra la sesión del usuario.
         */
        async function handleLogout() {
            try { await signOut(auth); } 
            catch (error) { console.error("Error al cerrar sesión:", error); }
        }

        /**
         * Maneja la navegación entre vistas.
         */
        function handleNavClick(e) {
            e.preventDefault();
            const targetView = e.currentTarget.dataset.view;

            viewSections.forEach(section => section.classList.remove('active'));
            document.getElementById(targetView).classList.add('active');

            navLinks.forEach(link => {
                link.classList.remove('bg-indigo-600', 'text-white');
                link.classList.add('text-neutral-300', 'hover:bg-slate-700', 'hover:text-white');
            });
            e.currentTarget.classList.add('bg-indigo-600', 'text-white');
            e.currentTarget.classList.remove('text-neutral-300', 'hover:bg-slate-700', 'hover:text-white');
            
            // Si se hace clic en Archivo, renderizarlo
            if (targetView === 'view-archive') {
                renderArchiveView();
            }
            feather.replace();
        }

        /**
         * Configura el listener de onSnapshot para obtener datos en tiempo real.
         */
        function setupSnapshotListener() {
            if (!userId) return; 
            if (unsubscribe) unsubscribe();

            loading.classList.remove('hidden');
            planillasContainer.classList.add('hidden');
            noResults.classList.add('hidden');
            archiveContainer.innerHTML = ''; // Limpiar archivo

            const q = query(collection(db, collectionPath));
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                allPlanillas = [];
                snapshot.forEach((doc) => {
                    allPlanillas.push({ id: doc.id, ...doc.data() });
                });
                
                // Ordenar por fecha de envío inicial (la principal)
                allPlanillas.sort((a, b) => new Date(b.fechaEnvio) - new Date(a.fechaEnvio));
                
                console.log(`Datos recibidos: ${allPlanillas.length} registros.`);
                renderPlanillas(); // Renderiza el dashboard por defecto
                
                // Pre-renderizar el archivo en segundo plano
                renderArchiveView();
                
                loading.classList.add('hidden');

            }, (error) => {
                console.error("Error al obtener datos:", error);
                loading.textContent = "Error al cargar los datos.";
            });
        }

        /**
         * Renderiza las tarjetas en el Dashboard aplicando filtros.
         */
        function renderPlanillas() {
            planillasContainer.innerHTML = '';

            const searchExp = searchExpediente.value.toLowerCase().trim();
            const filterEst = filterEstado.value;
            const filterStart = filterFechaInicio.value;
            const filterEnd = filterFechaFin.value;

            const filteredPlanillas = allPlanillas.filter(p => {
                const pDate = p.fechaEnvio; // Fecha inicial
                
                // 1. Filtro por N° Expediente (busca en todos los campos de expediente)
                const expPrincipal = p.expediente ? p.expediente.toLowerCase() : '';
                const expPresupuesto = p.expedientePresupuesto ? p.expedientePresupuesto.toLowerCase() : '';
                const expSecretaria = p.expedienteSecretaria ? p.expedienteSecretaria.toLowerCase() : '';
                
                if (searchExp && !expPrincipal.includes(searchExp) && !expPresupuesto.includes(searchExp) && !expSecretaria.includes(searchExp)) {
                    return false;
                }
                
                // 2. Filtro por Estado
                const estado = getEstado(p);
                if (filterEst && estado !== filterEst) {
                    return false;
                }
                
                // 3. Filtro por Fecha de Inicio (sobre la fecha de envío inicial)
                if (filterStart && pDate < filterStart) return false;
                
                // 4. Filtro por Fecha de Fin
                if (filterEnd && pDate > filterEnd) return false;
                
                return true;
            });

            if (filteredPlanillas.length === 0) {
                noResults.classList.remove('hidden');
                planillasContainer.classList.add('hidden');
            } else {
                noResults.classList.add('hidden');
                planillasContainer.classList.remove('hidden');
                filteredPlanillas.forEach(p => renderPlanillaCard(p, planillasContainer));
            }

            feather.replace();
        }

        /**
         * Crea y añade una tarjeta <div> al contenedor.
         */
        function renderPlanillaCard(planilla, container) {
            const card = document.createElement('div');
            card.className = "bg-slate-800 shadow-lg rounded-lg overflow-hidden relative border border-slate-700";
            
            const ueNombre = ueMap[planilla.unidadEjecutora] || "N/A";
            const estado = getEstado(planilla);
            
            let estadoBadge = '';
            if (estado === 'secretaria') estadoBadge = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-900/50 text-green-300">En Secretaría</span>';
            else if (estado === 'presupuesto') estadoBadge = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-900/50 text-blue-300">En Presupuesto</span>';
            else estadoBadge = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-900/50 text-yellow-300">En Oficina</span>';

            const tipoDocBadge = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-indigo-900/50 text-indigo-300">${planilla.tipoDocumento || 'Planilla'}</span>`;
            
            // Sección de Valores Monetarios
            let valoresHTML = '';
            const total = parseFloat(planilla.valorTotal);
            const neto = parseFloat(planilla.valorNeto);
            if (!isNaN(total) && total > 0) {
                valoresHTML = `
                    <div class="mt-4 pt-4 border-t border-slate-700">
                        <span class="text-sm text-neutral-400">Total: <strong class="text-white">L. ${total.toFixed(2)}</strong></span>
                        <span class="text-sm text-neutral-400 ml-4">Deduc: <strong class="text-red-400">L. ${(total - neto).toFixed(2)}</strong></span>
                        <span class="text-sm text-neutral-400 ml-4">Neto: <strong class="text-green-400">L. ${neto.toFixed(2)}</strong></span>
                    </div>
                `;
            }

            // Sección de Seguimiento
            let seguimientoHTML = '';
            if (planilla.fechaEnvioPresupuesto) {
                seguimientoHTML += `
                    <li class="flex items-center space-x-2 text-sm">
                        <i data-feather="arrow-right-circle" class="w-4 h-4 text-blue-400"></i>
                        <span class="text-neutral-300">Presupuesto: <strong class="text-white">${planilla.fechaEnvioPresupuesto}</strong> (Exp: ${planilla.expedientePresupuesto || 'N/A'})</span>
                    </li>`;
            }
            if (planilla.fechaEnvioSecretaria) {
                seguimientoHTML += `
                    <li class="flex items-center space-x-2 text-sm">
                        <i data-feather="check-circle" class="w-4 h-4 text-green-400"></i>
                        <span class="text-neutral-300">Secretaría: <strong class="text-white">${planilla.fechaEnvioSecretaria}</strong> (Exp: ${planilla.expedienteSecretaria || 'N/A'})</span>
                    </li>`;
            }
            if (seguimientoHTML === '') {
                seguimientoHTML = `<li class="flex items-center space-x-2 text-sm text-neutral-500 italic"><i data-feather="info" class="w-4 h-4"></i><span>Aún en oficina</span></li>`;
            }

            card.innerHTML = `
                <div class="p-5">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-lg font-semibold text-white">${planilla.expediente}</h3>
                            <p class="text-sm text-neutral-400">Envío inicial: ${planilla.fechaEnvio}</p>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            ${tipoDocBadge}
                            ${estadoBadge}
                        </div>
                    </div>
                    
                    <!-- Cuerpo de la tarjeta -->
                    <div class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm mt-4">
                        <div class="flex items-center space-x-2">
                            <i data-feather="briefcase" class="w-4 h-4 text-neutral-500"></i>
                            <span class="text-neutral-400">UE: <strong class="text-white" title="${ueNombre}">${ueNombre}</strong></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i data-feather="users" class="w-4 h-4 text-neutral-500"></i>
                            <span class="text-neutral-400">Tropa: <strong class="text-white">${planilla.tipoTropa}</strong></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i data-feather="package" class="w-4 h-4 text-neutral-500"></i>
                            <span class="text-neutral-400">Objeto: <strong class="text-white">${planilla.objetoGasto}</strong></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i data-feather="layers" class="w-4 h-4 text-neutral-500"></i>
                            <span class="text-neutral-400">Planilla: <strong class="text-white">${planilla.tipoPlanilla}</strong></span>
                        </div>
                    </div>

                    <!-- Seguimiento -->
                    <div class="mt-4 pt-4 border-t border-slate-700">
                        <h4 class="text-xs font-semibold text-neutral-400 uppercase mb-2">Seguimiento</h4>
                        <ul class="space-y-2">
                            ${seguimientoHTML}
                        </ul>
                    </div>
                    
                    <!-- Valores -->
                    ${valoresHTML}

                </div>
                <button class="delete-btn absolute top-3 right-3 text-red-500 hover:text-red-400 p-1 rounded-full hover:bg-slate-700" data-id="${planilla.id}" title="Eliminar">
                    <i data-feather="trash-2" class="w-4 h-4"></i>
                </button>
            `;
            container.appendChild(card);
        }

        /**
         * Renderiza la vista de Archivo (agrupado por fecha).
         */
        function renderArchiveView() {
            archiveContainer.innerHTML = '';
            
            // 1. Agrupar planillas
            const grouped = allPlanillas.reduce((acc, p) => {
                try {
                    const date = new Date(p.fechaEnvio + 'T00:00:00'); // Asegurar zona horaria local
                    if (isNaN(date)) throw new Error("Invalid date");
                    const year = date.getUTCFullYear().toString();
                    const month = monthNames[date.getUTCMonth()];
                    
                    if (!acc[year]) acc[year] = {};
                    if (!acc[year][month]) acc[year][month] = [];
                    acc[year][month].push(p);
                } catch(e) {
                    console.error("Fecha inválida:", p.fechaEnvio, p.id);
                }
                return acc;
            }, {});

            // 2. Renderizar HTML
            const sortedYears = Object.keys(grouped).sort().reverse(); // Años más nuevos primero

            if (sortedYears.length === 0) {
                archiveContainer.innerHTML = `<p class="text-center text-neutral-500 py-10">No hay registros para archivar.</p>`;
                return;
            }

            for (const year of sortedYears) {
                const yearDiv = document.createElement('div');
                yearDiv.className = 'year-group';
                
                let yearHTML = `<h3 class="text-2xl font-semibold text-white mb-6 border-b border-slate-700 pb-3">${year}</h3>`;
                const sortedMonths = Object.keys(grouped[year]).sort(); // Meses en orden (Ene, Feb...)
                
                let monthsHTML = '<div class="month-group space-y-8">';
                for (const month of sortedMonths) {
                    const monthKey = month.substring(3); // "Enero", "Febrero", etc.
                    monthsHTML += `
                        <div>
                            <h4 class="text-xl font-medium text-indigo-300 mb-4" data-month-key="${monthKey}">${monthKey}</h4>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Contenedor para tarjetas de este mes -->
                            </div>
                        </div>
                    `;
                }
                monthsHTML += '</div>';
                yearDiv.innerHTML = yearHTML + monthsHTML;
                
                archiveContainer.appendChild(yearDiv);

                // 3. Renderizar tarjetas dentro de sus contenedores
                for (const month of sortedMonths) {
                    const monthKey = month.substring(3);
                    const cardContainer = yearDiv.querySelector(`h4[data-month-key="${monthKey}"] + div.grid`);
                    
                    if (cardContainer) {
                        grouped[year][month].forEach(p => renderPlanillaCard(p, cardContainer));
                    }
                }
            }
            feather.replace();
        }


        /**
         * Determina el estado actual de una planilla.
         */
        function getEstado(planilla) {
            if (planilla.fechaEnvioSecretaria) return 'secretaria';
            if (planilla.fechaEnvioPresupuesto) return 'presupuesto';
            return 'oficina';
        }

        /**
         * Maneja el envío del formulario para agregar una nueva planilla.
         */
        async function handleAddFormSubmit(e) {
            e.preventDefault();
            if (!userId) return; 
            
            const formData = new FormData(addForm);
            
            const total = parseFloat(formData.get('valorTotal')) || 0;
            const deducciones = parseFloat(formData.get('valorDeducciones')) || 0;
            
            const nuevaPlanilla = {
                tipoDocumento: formData.get('tipoDocumento'),
                expediente: formData.get('expediente'),
                fechaEnvio: formData.get('fechaEnvio'),
                unidadEjecutora: formData.get('unidadEjecutora'),
                objetoGasto: formData.get('objetoGasto'),
                tipoTropa: formData.get('tipoTropa'),
                tipoPlanilla: formData.get('tipoPlanilla'),
                
                fechaEnvioPresupuesto: formData.get('fechaEnvioPresupuesto') || null,
                expedientePresupuesto: formData.get('expedientePresupuesto') || null,
                
                fechaEnvioSecretaria: formData.get('fechaEnvioSecretaria') || null,
                expedienteSecretaria: formData.get('expedienteSecretaria') || null,
                
                valorTotal: total,
                valorDeducciones: deducciones,
                valorNeto: total - deducciones,
                
                createdAt: Timestamp.now()
            };

            try {
                await addDoc(collection(db, collectionPath), nuevaPlanilla);
                addForm.reset();
                calculateNeto(); // Resetear neto
                toggleFields(fieldsPresupuesto, false);
                toggleFields(fieldsSecretaria, false);
                // Navegar de vuelta al dashboard
                handleNavClick({ preventDefault: () => {}, currentTarget: document.querySelector('a[data-view="view-dashboard"]') });
            } catch (error) {
                console.error("Error al agregar documento: ", error);
            }
        }

        /**
         * Maneja el clic en los botones de eliminar.
         */
        async function handleDeleteClick(e) {
            if (!userId) return; 

            let target = e.target;
            while (target != null && !target.classList.contains('delete-btn')) {
                target = target.parentElement;
            }

            if (target && target.classList.contains('delete-btn')) {
                const docId = target.dataset.id;
                if (await showDeleteConfirmation()) {
                    try {
                        await deleteDoc(doc(db, collectionPath, docId));
                    } catch (error) {
                        console.error("Error al eliminar documento:", error);
                    }
                }
            }
        }

        /**
         * Muestra un modal de confirmación (custom).
         */
        function showDeleteConfirmation() {
            return new Promise((resolve) => {
                const modalOverlay = document.createElement('div');
                modalOverlay.className = "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50";
                modalOverlay.innerHTML = `
                    <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm border border-slate-700">
                        <h3 class="text-lg font-medium text-white">Confirmar Eliminación</h3>
                        <p class="mt-2 text-sm text-neutral-400">¿Estás seguro de que deseas eliminar este registro? Esta acción no se puede deshacer.</p>
                        <div class="mt-4 flex justify-end space-x-3">
                            <button id="cancelDelete" class="py-2 px-4 border border-slate-600 rounded-md shadow-sm text-sm font-medium text-neutral-200 bg-slate-700 hover:bg-slate-600">Cancelar</button>
                            <button id="confirmDelete" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700">Eliminar</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modalOverlay);

                document.getElementById('confirmDelete').onclick = () => {
                    document.body.removeChild(modalOverlay);
                    resolve(true);
                };
                document.getElementById('cancelDelete').onclick = () => {
                    document.body.removeChild(modalOverlay);
                    resolve(false);
                };
            });
        }

        function clearFilters() {
            filterForm.reset();
            renderPlanillas();
        }

        /**
         * Muestra/oculta los campos dependientes de un checkbox.
         */
        function toggleFields(fieldsDiv, isChecked) {
            if (isChecked) {
                fieldsDiv.classList.remove('hidden');
            } else {
                fieldsDiv.classList.add('hidden');
                // Limpiar campos al ocultar
                fieldsDiv.querySelectorAll('input').forEach(input => input.value = '');
            }
        }

        /**
         * Calcula el valor neto a pagar.
         */
        function calculateNeto() {
            const total = parseFloat(valorTotal.value) || 0;
            const deducciones = parseFloat(valorDeducciones.value) || 0;
            const neto = total - deducciones;
            valorNeto.value = isNaN(neto) ? '0.00' : neto.toFixed(2);
        }

        // --- Event Listeners ---
        loginButton.addEventListener('click', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        navLinks.forEach(link => link.addEventListener('click', handleNavClick));
        
        addForm.addEventListener('submit', handleAddFormSubmit);
        // Usar 'planillasContainer' y 'archiveContainer' para la delegación de eventos de borrado
        planillasContainer.addEventListener('click', handleDeleteClick);
        archiveContainer.addEventListener('click', handleDeleteClick);
        
        filterButton.addEventListener('click', renderPlanillas);
        clearFilterButton.addEventListener('click', clearFilters);

        // Listeners para el formulario de agregar
        checkPresupuesto.addEventListener('change', (e) => toggleFields(fieldsPresupuesto, e.target.checked));
        checkSecretaria.addEventListener('change', (e) => toggleFields(fieldsSecretaria, e.target.checked));
        valorTotal.addEventListener('input', calculateNeto);
        valorDeducciones.addEventListener('input', calculateNeto);

        // --- Inicialización ---
        initializeFirebase();
        feather.replace(); // Cargar iconos iniciales
    </script>
</body>
</html>